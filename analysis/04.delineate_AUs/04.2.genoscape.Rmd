---
title: "04.2.genoscape"
author: "Erica Robertson"
date: "2025-09-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/Desktop/BANS_adaptive_units/analysis/04.delineate_AUs/")
```

```{r, message=FALSE, warning=FALSE}
library(raster)
library(tidyverse)
library(sf)
library(ggspatial)
library(terra)
library(ggrepel)
#remotes::install_github("eriqande/TESS3_encho_sen")  # for special version of tess3r
#BiocManager::install("SNPRelate")
#remotes::install_github("eriqande/genoscapeRtools")
library(genoscapeRtools)
library(tess3r)
library(rnaturalearth)
#remotes::install_github("mgdesaix/mignette")
library(mignette)
library(terra)
library(lwgeom)
library(fields)
library(ggplot2)
```

To start, load the .Q file(s). If you did a single admixture run (not hierarchical). It's pretty easy. Load the admixture proportions and merge with a sample list you (same order as admix input).
```{r, message=FALSE, warning=FALSE}
Q_tibble <- read_table2("BANS.cand_snps.3.Q",col_names = F) %>% rename(grp1=X1, grp2=X2, grp3=X3)

#extract sample names in order from a plink file
inds <- read.table("../03.GEA/BANS_sample_list_pop.tsv") %>% rename(Sample=V1) %>% dplyr::select(Sample)

# add those sample names to the q values
Q_tibble <- bind_cols(inds, Q_tibble)
```

Now we can make the genoscape.
```{r, message=FALSE, warning=FALSE}
meta <- read.csv("../../data/BANS_sample_data.csv") %>% rename(BGP_ID=BGP.ID) %>%
  filter(BGP_ID %in% inds$Sample) %>%
  mutate(Region_site=paste(State, Lat, Long, sep="_"), Region_pop=State)
  

LatLong_tibble <- Q_tibble %>%
  dplyr::select(Sample) %>%
  left_join(meta, by = c("Sample" = "BGP_ID")) %>%
  dplyr::select(Sample, Lat, Long)

Au.grouping <- read.csv("../04.delineate_AUs/BANS_AUgrouping.csv")
  
# set cluster colors
cluster_colors <-  c(
  "grp1" = "#FFD92FFF",
  "grp2" = "#FF4500",
  "grp3" = "#C51B8A"
)

# load breeding range
breeding_range <- st_read("../../data/spatial_files/banswa_range_2023/banswa_range_2023.gpkg", quiet = TRUE) %>%
  filter(season == "breeding")


# prepare the data for tess3Q_map_rasters
long_lat_tibble <- Q_tibble %>%
  dplyr::select(Sample) %>%
  left_join(LatLong_tibble, by = "Sample") %>%
  dplyr::select(Long, Lat) 

long_lat_matrix <- long_lat_tibble %>%
  as.matrix()

# make a matrix of Q values
Q_matrix <- Q_tibble %>%
  dplyr::select(-Sample) %>%
  as.matrix()

# interpolate the Q-values by kriging using tess3r::tess3Q_map_rasters()
genoscape_brick <- tess3r::tess3Q_map_rasters(
  x = Q_matrix, 
  coord = long_lat_matrix,  
  map.polygon = breeding_range,
  window = extent(breeding_range)[1:4],
  resolution = c(1000,1000), # if you want more cells in your raster, set higher
  # this next lines need to to be here, but don't do much...
  col.palette = tess3r::CreatePalette(cluster_colors, length(cluster_colors)), 
  method = "map.max", 
  interpol = tess3r::FieldsKrigModel(10),  
  main = "Ancestry coefficients",
  xlab = "Longitude", 
  ylab = "Latitude", 
  cex = .4
)

# after that, we need to add names of the clusters back onto this raster brick
names(genoscape_brick) <- names(Q_tibble)[-1]

writeRaster(genoscape_brick, "../05.predictors_of_decline/spatial_predictors/BANS_genoscape_brick.tif", overwrite = TRUE)

# scaling and cleaning the genoscape_brick
genoscape_rgba <- genoscapeRtools::qprob_rando_raster(
  TRB = genoscape_brick,
  cols = cluster_colors, 
  alpha_scale = 2.0, 
  abs_thresh = 0.0, 
  alpha_exp = 1.55, 
  alpha_chop_max = 230
)

# at this point, we must be explicit about adding a projection to the raster.
# this adds the info for a regular lat-long projection
crs(genoscape_rgba) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

```

```{r, message=FALSE, warning=FALSE, results='hide'}
# get shapefiles from natural earth
coastlines <- ne_download(scale = 10, type = "coastline", category = "physical", returnclass = "sf")
countries <- ne_download(scale = 10, type = "admin_0_boundary_lines_land", category = "cultural", returnclass = "sf")
states <- ne_download(scale = 10, type = "admin_1_states_provinces_lines", category = "cultural", returnclass = "sf")
ocean <- ne_download(scale = 10, type = "ocean", category = "physical", returnclass = "sf")
lakes <- ne_download(scale = 10, type = "lakes", category = "physical", returnclass = "sf")
```

```{r, message=FALSE, warning=FALSE}
# reproject to a Lambert conic projection
lamproj <- "+proj=lcc +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-100 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"
genoscape_spat <- rast(genoscape_rgba)
writeRaster(genoscape_spat, "../05.predictors_of_decline/spatial_predictors/BANS_genoscape.tif")
genoscape_projected <- terra::project(genoscape_spat, lamproj, method = "near")

# plot it
genoscape <- ggplot() +
  ggspatial::layer_spatial(genoscape_projected) +
  geom_sf(data = breeding_range, fill = NA, linewidth = 0.1225 , alpha = 0.6) +
  geom_sf(data = countries, fill = NA, linewidth = 0.25) +
  geom_sf(data = coastlines, fill = NA, linewidth = 0.1225) +
  geom_sf(data = states, fill = NA, linewidth = 0.1225) +
  geom_sf(data = ocean, fill = "#bddbe6") +
  geom_sf(data = lakes, fill = "#bddbe6") +
  #geom_spatial_point(data = long_lat_tibble, mapping = aes(x = Long, y = Lat), size=1, alpha = 0.7) + 
  theme_void() + 
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1)) +
  coord_sf(
    crs = st_crs(lamproj), 
    xlim = c(-4000000, 3400000), 
    ylim = c(-3000000, 3000000),
    expand = FALSE)  # expand = FALSE means put the axes right at the xlim and ylim

ggsave("genoscape.png")
```

```{r}
countries_sf <- ne_countries(
  scale = 10,
  country = c("United States of America", "Canada"),
  returnclass = "sf"
)
breeding_range.mask <- sf::st_crop(breeding_range, countries_sf)
range <- ggplot()+
  geom_sf(data = countries_sf, fill = NA, linewidth = 0.25) +
  geom_sf(data = coastlines, fill = NA, linewidth = 0.1225) +
  geom_sf(data = states, fill = NA, linewidth = 0.1225) +
  geom_sf(data = ocean, fill = "#bddbe6") +
  geom_sf(data = lakes, fill = "#bddbe6")+
  geom_sf(data = breeding_range.mask, fill = "yellow", linewidth = 0.1225 , alpha = 0.6)

ggplotly(range)
```

```{r}
genoscape_df <- as.data.frame(genoscape_projected, xy = TRUE, na.rm = TRUE)

gg <- ggplot() +
  geom_raster(data = genoscape_df, aes(x = x, y = y, fill = red)) + # use the correct layer name
  geom_sf(data = breeding_range, fill = NA, color = "black") +
  geom_point(data = long_lat_tibble, aes(x = Long, y = Lat), size = 1, alpha = 0.7) +
  theme_minimal()

plotly::ggplotly(gg)
```

```{r}

ontario <- ggplot() +
  ggspatial::layer_spatial(genoscape_projected) +
  geom_sf(data = breeding_range, fill = NA, linewidth = 0.1225 , alpha = 0.6) +
  geom_sf(data = countries, fill = NA, linewidth = 0.25) +
  geom_sf(data = coastlines, fill = NA, linewidth = 0.1225) +
  geom_sf(data = states, fill = NA, linewidth = 0.1225) +
  geom_sf(data = ocean, fill = "#bddbe6") +
  geom_sf(data = lakes, fill = "#bddbe6") +
  #geom_spatial_point(data = long_lat_tibble, mapping = aes(x = Long, y = Lat), size=2) + 
  theme_void() + 
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1)) +
  theme(
    panel.background = element_rect(fill = "white", color = NA), 
    plot.background  = element_rect(fill = "white", color = NA)
  ) +
  coord_sf(
    crs = st_crs(lamproj), 
    xlim = c(1350000, 1750000), 
    ylim = c(0500000, 0850000),
    expand = FALSE)  # expand = FALSE means put the axes right at the xlim and ylim

ontario

channel_isl <- ggplot() +
  ggspatial::layer_spatial(genoscape_projected) +
  geom_sf(data = breeding_range, fill = NA, linewidth = 0.1225 , alpha = 0.6) +
  geom_sf(data = countries, fill = NA, linewidth = 0.25) +
  geom_sf(data = coastlines, fill = NA, linewidth = 0.1225) +
  geom_sf(data = states, fill = NA, linewidth = 0.1225) +
  geom_sf(data = ocean, fill = "#bddbe6") +
  geom_sf(data = lakes, fill = "#bddbe6") +
  #geom_spatial_point(data = long_lat_tibble, mapping = aes(x = Long, y = Lat), size=2) + 
  theme_void() + 
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1)) +
  theme(
    panel.background = element_rect(fill = "white", color = NA), 
    plot.background  = element_rect(fill = "white", color = NA)
  ) +
  coord_sf(
    crs = st_crs(lamproj),
    xlim = c(-1800000, -1500000), 
    ylim = c(-0700000, -0350000),
    expand = FALSE)  # expand = FALSE means put the axes right at the xlim and ylim

channel_isl


library(cowplot)

genoscape_boxed <- genoscape +
  geom_rect(aes(xmin = 1350000, xmax = 1750000, ymin = 500000, ymax = 850000),
            color = "red", fill = NA, linewidth = 0.5) +  # Ontario box
  geom_rect(aes(xmin = -1800000, xmax = -1500000, ymin = -700000, ymax = -350000),
            color = "red", fill = NA, linewidth = 0.5) 

final_map <- ggdraw() +
  draw_plot(genoscape_boxed) +  # main map
  draw_plot(ontario, x = 0.65, y = 0.65, width = 0.3, height = 0.3) +  # inset Ontario
  draw_plot(channel_isl, x = 0.00, y = 0.00, width = 0.4, height = 0.4) # inset Channel Islands

final_map

#ggsave("LOSH_genoscape_insets.svg", final_map)
``` 

```{r, message=FALSE, warning=FALSE}
library(pophelper)
Q <- readQ("../admix-july-25/311ind-pass-maf05-snp-miss50-scafmt10-gtglimpute4.1-exclLD50-5-0.5-admix-K4-alpha0-r1.admix.4.Q")


```
I want to create shapefiles for each genetic group to get demographic data for, either from ebird population trends or BBS. Matt has function for this in Mignette, so install and load that package if you haven't already.
```{r, message = FALSE, warning = FALSE}
# terra::writeRaster(
#   genoscape_brick,
#   filename = "LOSH.genoscape_rgba.tif",
#   filetype = "GTiff",
#   overwrite = TRUE
# )

crs(genoscape_brick) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
genoscape_brick_spat <- rast(genoscape_brick)
genoscape_brick_proj <- terra::project(genoscape_brick_spat, lamproj, method = "near")

genoscape_polygons <- mignette::scape_to_shape(x = genoscape_brick_proj, 
                                               prob_threshold = 0.5,
                                               d = 100,
                                               f = 100,
                                               s = 3)

polygons <- ggplot() +
  ggspatial::layer_spatial(genoscape_polygons, aes(fill = as.factor(Cluster))) +
  #geom_sf(data = breeding_range, fill = NA, linewidth = 0.1225 , alpha = 0.6) +
  geom_sf(data = countries, fill = NA, linewidth = 0.25) +
  geom_sf(data = coastlines, fill = NA, linewidth = 0.1225) +
  geom_sf(data = states, fill = NA, linewidth = 0.1225) +
  #geom_sf(data = ocean, fill = "#bddbe6") +
  #geom_sf(data = lakes, fill = "#bddbe6") +
  #geom_spatial_point(data = long_lat_tibble, mapping = aes(x = Long, y = Lat), size=2) +
  theme_void() + 
  #theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1)) +
  coord_sf(
    crs = st_crs(lamproj), 
    xlim = c(-4000000, 3400000),
    ylim = c(-3000000, 3000000),
    expand = FALSE)  # expand = FALSE means put the axes right at the xlim and ylim

polygons

polygons_ci <- ggplot() +
  ggspatial::layer_spatial(genoscape_polygons, aes(fill = as.factor(Cluster))) +
  #geom_sf(data = breeding_range, fill = NA, linewidth = 0.1225 , alpha = 0.6) +
  geom_sf(data = countries, fill = NA, linewidth = 0.25) +
  geom_sf(data = coastlines, fill = NA, linewidth = 0.1225) +
  geom_sf(data = states, fill = NA, linewidth = 0.1225) +
  #geom_sf(data = ocean, fill = "#bddbe6") +
  #geom_sf(data = lakes, fill = "#bddbe6") +
  #geom_spatial_point(data = long_lat_tibble, mapping = aes(x = Long, y = Lat), size=2) +
  theme_void() + 
  #theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1)) +
  coord_sf(
    crs = st_crs(lamproj), 
    # xlim = c(-4000000, 3400000), 
    # ylim = c(-3000000, 3000000),
    xlim = c(-1800000, -1500000), 
    ylim = c(-0700000, -0350000),
    expand = FALSE)  # expand = FALSE means put the axes right at the xlim and ylim

polygons_ci

polygons_on <- ggplot() +
  ggspatial::layer_spatial(genoscape_polygons, aes(fill = as.factor(Cluster))) +
  #geom_sf(data = breeding_range, fill = NA, linewidth = 0.1225 , alpha = 0.6) +
  geom_sf(data = countries, fill = NA, linewidth = 0.25) +
  geom_sf(data = coastlines, fill = NA, linewidth = 0.1225) +
  geom_sf(data = states, fill = NA, linewidth = 0.1225) +
  #geom_sf(data = ocean, fill = "#bddbe6") +
  #geom_sf(data = lakes, fill = "#bddbe6") +
  #geom_spatial_point(data = long_lat_tibble, mapping = aes(x = Long, y = Lat), size=2) +
  theme_void() + 
  #theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1)) +
  coord_sf(
    crs = st_crs(lamproj),
    xlim = c(1350000, 1750000), 
    ylim = c(0500000, 0850000),
    expand = FALSE)  # expand = FALSE means put the axes right at the xlim and ylim

polygons_on
#ggsave("LOSH_genoscape_polygons.svg", polygons, width = 8, height = 6, dpi = 300)

#st_write(genoscape_polygons, "LOSH_genoscape_polygons.shp", delete_layer = TRUE)

```



